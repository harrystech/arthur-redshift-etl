{
    "objects": [
        {
            "id": "Default",
            "name": "Default",
            "schedule": { "ref": "ETLSchedule" },
            "scheduleType": "cron",
            "failureAndRerunMode": "CASCADE",
            "resourceRole": "DataPipelineDefaultResourceRole",
            "role": "DataPipelineDefaultRole",
            "pipelineLogUri": "s3://#{myS3Bucket}/#{myEtlEnvironment}/logs/",
            "region": "us-east-1",
            "maximumRetries": "2"
        },
        {
            "id": "ETLSchedule",
            "name": "Run every day close to midnight (America/NewYork)",
            "type": "Schedule",
            "period": "1 days",
            "startDateTime": "#{myStartDateTime}",
            "occurrences": "#{myOccurrences}"
        },
        {
            "id": "SNSParent",
            "topicArn": "arn:aws:sns:us-east-1:${resources.VPC.account}:etl-status-#{myEtlEnvironment}"
        },
        {
            "id": "SuccessNotification",
            "type": "SnsAlarm",
            "parent": {"ref": "SNSParent"},
            "subject": "ETL Rebuild Success: #{myEtlEnvironment} at #{node.@scheduledStartTime}",
            "message": "Completed last action successfully at #{node.@actualEndTime}\\nLast node: #{node.name}\\nPipelineId: #{node.@pipelineId}\\nLog directory: #{node.pipelineLogUri}#{node.@pipelineId}"
        },
        {
            "id": "FailureNotification",
            "type": "SnsAlarm",
            "parent": {"ref": "SNSParent"},
            "subject": "ETL Rebuild Failure: #{myEtlEnvironment} at #{node.@scheduledStartTime}",
            "message": "Failed step #{node.name} at #{node.@actualEndTime}\\nPipelineId: #{node.@pipelineId}\\nSphere: #{node.@sphere}\\nCancellation reason: #{node.cancellationReason}\\nLog directory: #{node.pipelineLogUri}#{node.@pipelineId}\\n\\nError stacktrace: #{node.errorStackTrace}"
        },
        {
            "id": "PagerNotification",
            "type": "SnsAlarm",
            "topicArn": "arn:aws:sns:us-east-1:${resources.VPC.account}:etl-page-#{myEtlEnvironment}",
            "subject": "ETL Rebuild Failure: #{myEtlEnvironment} at #{node.@scheduledStartTime}",
            "message": "Failed step #{node.name} at #{node.@actualEndTime}\\nPipelineId: #{node.@pipelineId}\\nSphere: #{node.@sphere}\\nCancellation reason: #{node.cancellationReason}\\nLog directory: #{node.pipelineLogUri}#{node.@pipelineId}\\n\\nError stacktrace: #{node.errorStackTrace}"
        },
        {
            "id": "ResourceParent",
            "keyPair": "${resources.key_name}",
            "subnetId": "${resources.VPC.public_subnet}",
            "terminateAfter": "8 Hours"
        },
        {
            "id": "ETLCluster",
            "name": "ETL EMR Cluster",
            "type": "EmrCluster",
            "parent": { "ref": "ResourceParent" },
            "releaseLabel": "${resources.EMR.release_label}",
            "masterInstanceType": "${resources.EMR.master.instance_type}",
            "coreInstanceType": "${resources.EMR.core.instance_type}",
            "coreInstanceCount": "${resources.EMR.core.instance_count}",
            "emrManagedMasterSecurityGroupId": "${resources.EMR.master.managed_security_group}",
            "emrManagedSlaveSecurityGroupId": "${resources.EMR.core.managed_security_group}",
            "additionalMasterSecurityGroupIds": [ "${resources.VPC.whitelist_security_group}" ],
            "bootstrapAction": "s3://#{myS3Bucket}/#{myEtlEnvironment}/bin/bootstrap.sh,#{myS3Bucket},#{myEtlEnvironment}",
            "applications": [ "Spark", "Ganglia", "Zeppelin", "Sqoop" ],
            "configuration": []
        },
        {
            "id": "ArthurDriverEC2Resource",
            "type": "Ec2Resource",
            "parent": { "ref": "ResourceParent" },
            "actionOnTaskFailure": "terminate",
            "actionOnResourceFailure": "retryAll",
            "instanceType": "${resources.EC2.instance_type}",
            "imageId": "${resources.EC2.image_type}",
            "securityGroupIds": [
                "${resources.EC2.public_security_group}",
                "${resources.VPC.whitelist_security_group}"
            ],
            "associatePublicIpAddress": "true"
        },
        {
            "id": "Ec2CommandGrandParent",
            "runsOn": {"ref": "ArthurDriverEC2Resource"}
        },
        {
            "id": "ShellCommandParent",
            "parent": {"ref": "Ec2CommandGrandParent"}
        },
        {
            "id": "ArthurCommandParent",
            "parent": {"ref": "Ec2CommandGrandParent"},
            "maximumRetries": "0"
        },
        {
            "id": "EmrActivityUpstreamExtract",
            "name": "Arthur Extract (EMR Activity)",
            "type": "EmrActivity",
            "step": "/var/lib/aws/emr/step-runner/hadoop-jars/command-runner.jar,/tmp/redshift_etl/venv/bin/arthur.py,--config,/tmp/redshift_etl/config/,extract,--prolix,--prefix,#{myEtlEnvironment},--max-partitions,#{myMaxPartitions}",
            "runsOn": { "ref": "ETLCluster" },
            "maximumRetries": "0"
        },
        {
            "id": "CopyBootstrap",
            "name": "Copy Bootstrap (EC2)",
            "type": "ShellCommandActivity",
            "parent": { "ref": "ShellCommandParent" },
            "command": "(sudo yum -y update aws-cli) && /usr/bin/aws s3 cp s3://#{myS3Bucket}/#{myEtlEnvironment}/bin/bootstrap.sh /tmp/bootstrap.sh"
        },
        {
            "id": "Bootstrap",
            "name": "Bootstrap (EC2)",
            "type": "ShellCommandActivity",
            "parent": { "ref": "ShellCommandParent" },
            "command": "bash /tmp/bootstrap.sh #{myS3Bucket} #{myEtlEnvironment}",
            "dependsOn": { "ref": "CopyBootstrap" }
        },
        {
            "id": "PingCronutAfterBootstrap",
            "name": "Ping Cronut After Bootstrap (EC2)",
            "type": "ShellCommandActivity",
            "parent": { "ref":"ShellCommandParent" },
            "command": "bash /tmp/redshift_etl/bin/ping_cronut.sh PING_AFTER_BOOTSTRAP",
            "dependsOn": { "ref": "Bootstrap" }
        },
        {
            "id": "ArthurLoad",
            "name": "Arthur Load (EC2)",
            "type": "ShellCommandActivity",
            "parent": { "ref": "ArthurCommandParent" },
            "command": "/tmp/redshift_etl/venv/bin/arthur.py --config /tmp/redshift_etl/config/ load --prolix --prefix #{myEtlEnvironment} --concurrent-extract --max-concurrency #{myMaxConcurrency} --wlm-query-slots #{myWlmQuerySlots}",
            "dependsOn": [
                { "ref": "Bootstrap" }
            ]
        },
        {
            "id": "PublishAndBackup",
            "name": "Publish and Backup (EC2)",
            "type": "ShellCommandActivity",
            "parent": {"ref": "ShellCommandParent"},
            "command": "bash /tmp/redshift_etl/bin/sync_env.sh -y #{myS3Bucket} #{myEtlEnvironment} #{myEtlEnvironment}/current",
            "dependsOn": { "ref": "ArthurLoad" }
        },
        {
            "id": "ArthurUnload",
            "name": "Arthur Unload (EC2)",
            "type": "ShellCommandActivity",
            "parent": {"ref": "ArthurCommandParent"},
            "command": "/tmp/redshift_etl/venv/bin/arthur.py --config /tmp/redshift_etl/config/ unload --prolix --keep-going --prefix #{myEtlEnvironment}",
            "dependsOn": {"ref": "ArthurLoad"}
        },
        {
            "id": "PingCronutAfterEtl",
            "name": "Ping Cronut After ETL (EC2)",
            "type": "ShellCommandActivity",
            "parent": { "ref":"ShellCommandParent" },
            "command": "bash /tmp/redshift_etl/bin/ping_cronut.sh PING_AFTER_ETL",
            "dependsOn": [
                { "ref": "PublishAndBackup" },
                { "ref": "ArthurUnload" }
            ],
            "onSuccess": { "ref": "SuccessNotification" },
            "onFail": [
                { "ref": "FailureNotification" },
                { "ref": "PagerNotification" }
            ]
        }
    ],
    "parameters": [
        {
            "id": "myS3Bucket",
            "type": "String",
            "optional": "false",
            "description": "Name of S3 bucket",
            "watermark": "data_lake_bucket",
            "helpText": "Pick the name of the data lake."
        },
        {
            "id": "myEtlEnvironment",
            "type": "String",
            "optional": "false",
            "description": "Name of ETL environment",
            "watermark": "production",
            "helpText": "Pick the name such as 'production', 'development' or your user name."
        },
        {
            "id": "myStartDateTime",
            "type": "String",
            "optional": "false",
            "description": "UTC ISO formatted string giving the datetime to start the pipeline",
            "watermark": "2525-01-01T00:00:00",
            "helpText": "When should the pipeline's daily cadence start?"
        },
        {
            "id": "myOccurrences",
            "type": "String",
            "optional": "false",
            "description": "Number of occurrences for this pipeline",
            "watermark": "1000",
            "helpText": "How often should the pipeline schedule be repeated?"
        }
    ],
    "values": {
        "myS3Bucket": "data_lake_bucket",
        "myEtlEnvironment": "development",
        "myStartDateTime": "2525-01-01T00:00:00",
        "myOccurrences": "1000",
        "myMaxPartitions": "16",
        "myMaxConcurrency": "4",
        "myWlmQuerySlots": "3"
    }
}
